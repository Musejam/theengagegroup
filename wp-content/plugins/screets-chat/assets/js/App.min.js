/*
 * Screets Chat
 * Application scripts
 *
 * Copyright (c) 2013 Screets
 */
(function(b){b(document).ready(function(){a.init()});var a={data:{first_time:true,last_log_ID:0,no_activity:0,sender:"",win_is_active:0,sc_chat_box_visible:false},init:function(){var c=false;window.onfocus=function(){a.data.win_is_active=1};window.onblur=function(){a.data.win_is_active=0};if(sc_chat.is_admin==true){var e="action=sc_chat_ajax_callback&f_chat_user_name="+sc_chat.username+"&f_chat_user_email="+sc_chat.email+"&f_chat_is_admin=true";b.sc_POST("login",e,function(g){c=false;if(g.error){a.display_error(g.error)}else{a.login(g.name,g.gravatar,true)}});b(document).on("click",".sc-chat-users .user",function(){var g=b(this).attr("data-receiver-id");var h=b(this).attr("data-visitor-id");a.open_new_tab(g,h,true);return false});b("ul.sc-chat-tabs").each(function(){var g,h=b(this).find("li");h.addClass("active");h.not(g).each(function(){b(b(this).attr("href")).hide()});b(document).on("click",".sc-chat-tab-content",function(){b("ul.sc-chat-tabs li.active").removeClass("new-msg")});b(this).on("click","li a",function(i){b("ul.sc-chat-tabs li").removeClass("active new-msg");b(".sc-chat-tab-content").removeClass("active");g=b(this).parent();h=b(b(this).attr("href"));g.addClass("active");h.addClass("active");b(".sc-cnv-wrap").scrollTop(10000);h.find(".f-chat-line").focus();i.preventDefault()});b(this).on("click","li .close",function(j){var i=b(this).prev().attr("data-receiver-id");b("ul.sc-chat-tabs li").removeClass("active new-msg");b(".sc-chat-tab-content").removeClass("active");b(".console-tab").addClass("active");b("#Console").addClass("active");b("#Tab_"+i).remove();b("#Receiver_"+i).remove();j.preventDefault()})});b(".sc-chat-login-btn").click(function(){var g=b(this);a.data.current_status=b(this).attr("data-status");if(a.data.current_status=="online"){b.sc_POST("offline","action=sc_chat_ajax_callback",function(h){b('.user[data-user-type="1"]').fadeOut(1000);a.get_online_users();g.attr("data-status","offline").html('<i class="sc-icon-offline"></i> '+sc_chat.tr_offline);a.data.current_status="offline";b("#Chat_console").removeClass("sc-online").addClass("sc-offline");a.play_sound("offline")})}else{if(a.data.current_status=="offline"){b.sc_POST("online","action=sc_chat_ajax_callback",function(){a.get_online_users();b('.user[data-user-type="ME"]').show();g.attr("data-status","online").html('<i class="sc-icon-online"></i> '+sc_chat.tr_online);a.data.current_status="online";b("#Chat_console").removeClass("sc-offline").addClass("sc-online");a.play_sound("online")})}}});b(document).on("click",".sc-chat-refresh",function(){receiver_ID=b(this).parent().parent().parent().parent().attr("data-receiver-id");visitor_ID=b("#User_"+receiver_ID).attr("data-visitor-id");a.get_user_info(visitor_ID,receiver_ID)})}if(!sc_chat.is_admin){b("#SC_send_form_btn").click(function(){b("#SC_contact_form").submit()});b("#SC_contact_form").submit(function(){b(".sc-chat-notification").fadeIn(100).removeClass("error success").html(sc_chat.tr_sending+"...");b.sc_POST("send_contact_from",b(this).serialize(),function(g){if(g.error){b(".sc-chat-notification").addClass("error").html(g.error)}else{b(".sc-chat-notification").addClass("success").html(g.message).delay(1500).fadeOut(500);b(".sc-chat-header-title").html(g.message).delay(4000).queue(function(h){b(this).html(sc_chat.tr_offline_header);h()});b('#SC_contact_form input[type="text"], #SC_contact_form textarea').val("");setTimeout(a.hide_chatbox,2700)}});return false});b("#SC_start_chat_btn").click(function(){b("#SC_login_form").submit()});b("#SC_login_form input").keydown(function(g){if(g.keyCode==13){b("#SC_login_form").submit()}});b("#SC_login_form").submit(function(){if(c){return false}c=true;b.sc_POST("login",b(this).serialize(),function(g){c=false;if(g.error){a.display_error(g.error)}else{a.login(g.name,g.gravatar,true)}});return false});if(sc_chat.use_css_anim==1){setTimeout(a.animate_chatbox,(sc_chat.delay*500))}else{setTimeout(a.animate_chatbox,(sc_chat.delay*1000))}}b(document).on("keydown",".f-chat-line",function(g){if(g.keyCode==13&&!g.shiftKey){g.preventDefault();b(this).parent().submit();b(this).val("");b(this).trigger("autosize")}});b(document).on("submit","#Reply_form",function(){var h=b(this).find(".f-receiver-id").val();var j=b.trim(b(this).find(".f-chat-line").val());var l=b(this).serialize();var i=b(".f-chat-line");if(j.length==0){return false}if(c){return false}c=true;var g="t"+Math.round(Math.random()*1000000),k={ID:g,author:a.data.name,gravatar:a.data.gravatar,receiver_ID:h,chat_line:j.replace(/</g,"&lt;").replace(/>/g,"&gt;")};i.addClass("sc-chat-sending");a.add_chat_line(b.extend({},k));b.sc_POST("send_chat_msg",l,function(m){c=false;b(".f-chat-line").val("").removeClass("sc-chat-sending");b("div.chat-"+g).remove();if(m.error){a.display_error(m.error);b("#Reply_form .f-chat-line").attr("disabled","disabled").addClass("sc-chat-error")}else{k.ID=m.insert_ID;a.add_chat_line(b.extend({},k))}});return false});b(document).on("click",".sc-chat-btn-logout",function(){window.location.href="./";b.sc_POST("logout","action=sc_chat_ajax_callback");return false});b.sc_GET("is_user_logged_in","action=sc_chat_ajax_callback",function(g){var h=true;if(!sc_chat.is_admin&&sc_chat.is_op==true){h=false}if(g.logged&&h){a.login(g.user.name,g.user.email,false)}});(function f(){a.get_online_users(f)})();(function d(){a.get_chat_lines(d)})()},login:function(d,c,e){a.data.name=d;a.data.gravatar=c;a.data.logged_in=true;if(sc_chat.is_admin==true){b(".sc-chat-login-btn").attr("data-status","online").html('<i class="sc-icon-online"></i> '+sc_chat.tr_online);b("#Chat_console").addClass("sc-online")}else{a.open_chatbox();if(e==true){b(".sc-chat-wrapper").fadeOut(function(){b(".sc-chat-notification").html("").hide();b("#Conversation").fadeIn();b(".f-chat-line").focus().autosize();b(".sc-cnv-wrap").scrollTop(10000)})}else{b(".sc-chat-wrapper").hide();if(b.cookie("sc_chat_chatbox_status")=="on"){if(sc_chat.use_css_anim==1){delay=sc_chat.delay*500}else{delay=sc_chat.delay*1000}setTimeout(function(){b("#Conversation").show();b(".f-chat-line").autosize();b(".sc-cnv-wrap").scrollTop(10000)},delay);a.data.sc_chat_box_visible=true}}}a.data.first_time=false},render:function(f,g){var c=[];switch(f){case"login_top_bar":c=['<span><img src="',g.gravatar,'" width="23" height="23" />','<span class="name">',g.name,'</span><a href="" class="logoutButton rounded">',g.tr_logout,"</a></span>"];break;case"chat_line":c=['<div class="sc-msg-wrap chat chat-',g.ID,'" data-user-id="',g.author,'"><div class="sc-chat-time">',g.time,'</div><div class="sc-usr-avatar"><img src="',g.gravatar,'" width="38" height="38" onload="this.style.visibility=\'visible\'" />','</div><div class="sc-msg"><div class="sc-usr-name">',g.author,':</div><div class="sc-chat-line">',g.chat_line,'</div></div><div class="clearfix"></div></div>'];break;case"user":if(g.type==1){var d=g.ID}else{var d=g.visitor_ID}c=['<a id="User_',g.name,'" href="#Receiver_',g.ID,'" class="user" data-receiver-id="',g.name,'" data-visitor-id="',d,'" data-user-type="',g.type,'"><img class="avatar" src="',g.gravatar,'" onload="this.style.visibility=\'visible\'" /> <div class="username"> <strong>',g.name,"</strong> (",g.email,")<small>",g.tagline,"</small></div></a>"];break;case"new_tab_title":c=['<li class="',g.custom_class,'" id="Tab_',g.ID,'"><a href="#Receiver_',g.ID,'" data-receiver-id="',g.ID,'">',g.ID,'</a> <button type="button" class="close">&times;</button></li>'];break;case"new_tab_content":if(g.user_info){var e=g.user_info}else{var e='<a href="javascript:void(0)" class="sc-chat-refresh">Refresh</a>'}c=['<div id="Receiver_',g.ID,'" data-receiver-id="',g.ID,'" class="',g.custom_class,' sc-chat-tab-content"><div class="sc-chat-inner"><div id="SC_cnv_wrap" class="sc-cnv-wrap"><div class="sc-chat-user-agent">',e,'</div></div><div class="sc-chat-tip"></div></div><form id="Reply_form" method="post" action="" class="sc-chat-reply"><input type="hidden" name="action" value="sc_chat_ajax_callback" /><input type="hidden" name="receiver_ID" class="f-receiver-id" value="',g.ID,'" /><input type="hidden" name="visitor_ID" class="f-visitor-id" value="',g.visitor_ID,'" /><textarea name="chat_line" class="f-chat-line" maxlength="700" placeholder="',sc_chat.tr_write_a_reply,'"></textarea></form></div>'];break}return c.join("")},open_new_tab:function(d,f,c){user_type=b('.sc-chat-users a[data-visitor-id="'+f+'"]').attr("data-user-type");var e=new Array();e.ID=d;e.visitor_ID=f;e.custom_class="";if(user_type=="1"||!f){e.user_info=""}else{e.user_info=sc_chat.tr_loading+"..."}if(b(".sc-chat-tabs li#Tab_"+d).length==0){if(b(".sc-chat-tabs .console-tab.active").length==1||c){b(".sc-chat-tabs li").removeClass("active");b(".sc-chat-tab-content").removeClass("active");e.custom_class="active "}b(".sc-chat-tabs").append(a.render("new_tab_title",e));b(".sc-chat-tab-contents").append(a.render("new_tab_content",e));b("#Receiver_"+d+" .f-chat-line").focus()}a.get_user_info(f,d);return false},get_user_info:function(d,c){a.data.receiver_ID=c;b.sc_GET("user_info","action=sc_chat_ajax_callback&ID="+d,function(e){if(e.device_name!="null"){a.data.user_info=e.device_name+" "+e.device_version+" - "+e.platform+", "+e.ip_address+' &nbsp; <a href="admin.php?page=sc_chat_m_chat_logs&action=edit&visitor_ID='+d+'" target="_blank">'+sc_chat.tr_chat_logs+"</a>";a.update_user_info()}})},update_user_info:function(){b("#Receiver_"+a.data.receiver_ID+" .sc-chat-user-agent").html(a.data.user_info)},add_chat_line:function(i){if(sc_chat.is_admin==true){if(i.author==sc_chat.username&&i.receiver_ID==sc_chat.username){a.data.sender=sc_chat.username}else{if(i.receiver_ID==sc_chat.username){a.data.sender=i.author}else{if(i.author==sc_chat.username){a.data.sender=i.receiver_ID}else{if(i.receiver_ID=="__OP__"){a.data.sender=i.author}}}}if(a.data.sender){var c=b("#User_"+a.data.sender).attr("data-visitor-id");a.open_new_tab(a.data.sender,c);a.update_user_info()}b("#Tab_"+i.author+":not(.active)").addClass("new-msg")}var h=new Date();if(i.time){h.setUTCHours(i.time.hours,i.time.minutes)}i.time=(h.getHours()<10?"0":"")+h.getHours()+":"+(h.getMinutes()<10?"0":"")+h.getMinutes();var e=a.render("chat_line",i);exists=b(".sc-cnv-wrap .chat-"+i.ID);if(exists.length){exists.remove()}if(!a.data.last_log_ID){b(".sc-cnv-wrap .sc-lead").remove()}if(sc_chat.is_admin==true){var f=b("#Receiver_"+a.data.sender+" .sc-cnv-wrap")}else{var f=b(".sc-cnv-wrap")}if(i.ID.toString().charAt(0)!="t"){var g=f.find(".chat-"+(+i.ID-1));if(g.length){g.after(e)}else{f.append(e)}}else{f.append(e)}b(".sc-cnv-wrap").scrollTop(100000);a.data.last_user=i.author},get_chat_lines:function(c){b.sc_GET("get_chat_lines",{last_log_ID:a.data.last_log_ID,action:"sc_chat_ajax_callback",sender:a.data.sender},function(e){for(var d=0;d<e.chats.length;d++){a.add_chat_line(e.chats[d])}if(e.chats.length){a.data.no_activity=0;a.data.last_log_ID=e.chats[d-1].ID;if(a.data.first_time!=true&&(a.data.win_is_active==0||sc_chat.is_admin==true)){a.play_sound("new_message")}}else{a.data.no_activity++}var f=1000;if(a.data.no_activity>3){f=2000}if(a.data.no_activity>10){f=5000}if(a.data.no_activity>20){f=15000}setTimeout(c,f)})},get_online_users:function(c){b.sc_GET("get_online_users",{action:"sc_chat_ajax_callback"},function(f){if(sc_chat.is_admin==true){var g=[];for(var d=0;d<f.users.length;d++){if(f.users[d]){g.push(a.render("user",f.users[d]))}}var e="";if(f.total<1){e=sc_chat.tr_no_one_online}else{if(f.total==1){e=sc_chat.tr_1_person_online}else{e=sc_chat.tr_x_people_online.replace("%s",f.total)}}g.push('<p class="count">'+e+"</p>");b("#People_list .sc-chat-users").html(g.join(""))}setTimeout(c,15000)})},animate_chatbox:function(){var c=b("#sc_chat_box");var d=b("#sc_chat_box .sc-chat-header");var e=c.innerHeight();var f=d.innerHeight();c.css("bottom","-"+e+"px");c.css("visibility","visible");if(sc_chat.use_css_anim==1){c.css("bottom","-"+(e-f)+"px").addClass("sc-chat-animated sc-chat-bounce-in-up");d.click(function(){b.removeCookie("sc_chat_chatbox_status");e=c.innerHeight();f=d.innerHeight();if(a.data.sc_chat_box_visible==false){e=c.innerHeight();f=d.innerHeight();c.css("bottom",0).addClass("sc-chat-css-anim");setTimeout(function(){if(window.innerWidth>480){if(b("#f_chat_user_name").length){b("#f_chat_user_name, .f-chat-line").focus()}else{b("#f_chat_user_email, .f-chat-line").focus()}}},500);if(a.data.logged_in==true){b("#Conversation").show();b(".f-chat-line").focus().autosize()}b.cookie("sc_chat_chatbox_status","on",{expires:1});a.data.sc_chat_box_visible=true}else{c.css("bottom","-"+(e-f)+"px");b.cookie("sc_chat_chatbox_status","off",{expires:1});a.data.sc_chat_box_visible=false}})}else{c.stop().animate({bottom:"+="+f},{duration:900,easing:"easeOutBack"});d.click(function(){b("#Conversation").show();b.removeCookie("sc_chat_chatbox_status");e=c.innerHeight();f=d.innerHeight();if(a.data.sc_chat_box_visible==false){c.stop().animate({bottom:0},{duration:200,easing:"easeOutExpo",complete:function(){if(window.innerWidth>480){if(b("#f_chat_user_name").length){b("#f_chat_user_name, .f-chat-line").focus()}else{b("#f_chat_user_email, .f-chat-line").focus()}}}});b.cookie("sc_chat_chatbox_status","on",{expires:1});a.data.sc_chat_box_visible=true}else{b.cookie("sc_chat_chatbox_status","off",{expires:1});c.stop().animate({bottom:"-"+(e-f)},{duration:190,easing:"easeOutExpo"});b.cookie("sc_chat_chatbox_status","off",{expires:1});a.data.sc_chat_box_visible=false}})}},open_chatbox:function(){var c=b("#sc_chat_box");b("#Reply_form .f-chat-line").removeAttr("disabled").removeClass("sc-chat-error");if(sc_chat.use_css_anim==1){c.css("bottom",0)}else{c.stop().animate({bottom:0},{duration:200,easing:"easeOutExpo"});b("#f_chat_user_name, .f-chat-line").focus()}},hide_chatbox:function(){var c=b("#sc_chat_box");var d=b("#sc_chat_box .sc-chat-header");sc_chat_box_h=c.innerHeight();sc_chat_header_h=d.innerHeight();if(sc_chat.use_css_anim==1){c.css("bottom","-"+(sc_chat_box_h-sc_chat_header_h)+"px")}else{c.stop().animate({bottom:"-"+(sc_chat_box_h-sc_chat_header_h)},{duration:190,easing:"easeOutExpo"})}a.data.sc_chat_box_visible=false},add_source:function(c,d){b("<source>").attr("src",d).appendTo(c)},play_sound:function(c){var d=b("<audio />",{autoPlay:"autoplay"});a.add_source(d,sc_chat.plugin_url+"/assets/sounds/"+c+".mp3");a.add_source(d,sc_chat.plugin_url+"/assets/sounds/"+c+".ogg");a.add_source(d,sc_chat.plugin_url+"/assets/sounds/"+c+".wav");d.appendTo("body")},display_error:function(c){b(".sc-chat-notification").show().addClass("error").html("").delay(500).html(c)}};b.sc_POST=function(d,c,e){b.post(sc_chat.ajaxurl+"?mode="+d,c,e,"json").error(function(f){console.log(f);return false})};b.sc_GET=function(d,c,e){b.get(sc_chat.ajaxurl+"?mode="+d,c,e,"json").error(function(f){console.log(f);return false})}}(window.jQuery||window.Zepto));